<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="shortcut icon" href="/favicon.svg">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaziBot ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00e5a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WaziBot">
<link rel="apple-touch-icon" href="/wazibot-logo-1024.png">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c27;
    --border: #2a2a3a;
    --accent: #00e5a0;
    --accent2: #7c5cfc;
    --danger: #ff4757;
    --warning: #ffa502;
    --text: #f0f0f8;
    --muted: #6b6b8a;
    --card-glow: 0 0 30px rgba(0, 229, 160, 0.06);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  .layout { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    padding: 28px 0;
    position: sticky; top: 0; height: 100vh;
  }
  .logo { padding: 0 24px 32px; border-bottom: 1px solid var(--border); }
  .logo h1 { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
  .logo h1 .wazi { color: var(--text); }
  .logo h1 .bot { color: var(--accent); }
  .logo span { font-size: 11px; color: var(--muted); display: block; margin-top: 2px; }
  .nav { padding: 20px 12px; flex: 1; }
  .nav-item {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 14px; border-radius: 10px;
    cursor: pointer; font-size: 14px; font-weight: 500;
    color: var(--muted); transition: all 0.2s; margin-bottom: 4px;
  }
  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); background: rgba(0,229,160,0.08); }
  .nav-item .icon { font-size: 18px; width: 22px; text-align: center; }
  .merchant-badge {
    margin: 12px; padding: 14px;
    background: var(--surface2); border-radius: 12px;
    border: 1px solid var(--border);
  }
  .merchant-badge .label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .merchant-badge .name { font-size: 13px; font-weight: 600; margin-top: 4px; color: var(--text); }
  .merchant-badge .status { font-size: 11px; color: var(--accent); margin-top: 2px; }
  .main { padding: 36px 40px; overflow-y: auto; }
  .page { display: none; }
  .page.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .page-header { margin-bottom: 32px; }
  .page-header h2 { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; }
  .page-header p { color: var(--muted); font-size: 14px; margin-top: 4px; }
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 22px; box-shadow: var(--card-glow);
    position: relative; overflow: hidden;
  }
  .stat-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }
  .stat-card .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  .stat-card .value { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; margin-top: 8px; }
  .stat-card .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .stat-card.green .value { color: var(--accent); }
  .stat-card.purple .value { color: var(--accent2); }
  .stat-card.red .value { color: var(--danger); }
  .stat-card.orange .value { color: var(--warning); }
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden; box-shadow: var(--card-glow);
  }
  .card-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-header h3 { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; }
  table { width: 100%; border-collapse: collapse; }
  th { padding: 12px 24px; text-align: left; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; border-bottom: 1px solid var(--border); }
  td { padding: 14px 24px; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.03); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
  }
  .badge.pending { background: rgba(255,165,2,0.15); color: var(--warning); }
  .badge.confirmed { background: rgba(0,229,160,0.15); color: var(--accent); }
  .badge.preparing { background: rgba(124,92,252,0.15); color: var(--accent2); }
  .badge.ready { background: rgba(0,229,160,0.2); color: var(--accent); }
  .badge.delivered { background: rgba(255,255,255,0.08); color: var(--muted); }
  .badge.cancelled { background: rgba(255,71,87,0.15); color: var(--danger); }
  .badge::before { content: '‚óè'; font-size: 8px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1 / -1; }
  label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  input, select, textarea {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px; border-radius: 10px; font-size: 14px;
    font-family: 'DM Sans', sans-serif; transition: border-color 0.2s; width: 100%;
  }
  input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
  textarea { resize: vertical; min-height: 80px; }
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 500;
    cursor: pointer; border: none; font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #00ffb3; transform: translateY(-1px); }
  .btn-danger { background: rgba(255,71,87,0.15); color: var(--danger); border: 1px solid rgba(255,71,87,0.3); }
  .btn-danger:hover { background: rgba(255,71,87,0.25); }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm { padding: 6px 12px; font-size: 12px; }
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center; z-index: 100;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 32px; width: 100%; max-width: 520px;
    animation: modalIn 0.3s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .modal h3 { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 24px; }
  .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 14px 20px; font-size: 14px;
    transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 200;
    display: flex; align-items: center; gap: 10px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: var(--accent); }
  .toast.error { border-color: var(--danger); }
  .empty { text-align: center; padding: 60px 24px; color: var(--muted); }
  .empty .icon { font-size: 48px; margin-bottom: 12px; }
  .empty p { font-size: 15px; }
  select.status-select { padding: 4px 10px; font-size: 12px; width: auto; }
  .loader { text-align: center; padding: 40px; color: var(--muted); font-size: 14px; }

  /* Ecran de connexion */
  .login-screen {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; align-items: center; justify-content: center; z-index: 300;
  }
  .login-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 40px; width: 100%; max-width: 400px;
    text-align: center;
  }
  .login-card h2 { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; margin-bottom: 8px; }
  .login-card h2 .wazi { color: var(--text); }
  .login-card h2 .bot { color: var(--accent); }
  .login-card p { color: var(--muted); font-size: 14px; margin-bottom: 28px; }
  .login-card input { margin-bottom: 12px; text-align: center; }
  .login-card .btn { width: 100%; justify-content: center; }
  .login-error { color: var(--danger); font-size: 13px; margin-top: 8px; display: none; }

  @media (max-width: 768px) {
    .layout { grid-template-columns: 1fr; }
    .sidebar { display: none; }
    .main { padding: 20px 16px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- Ecran de connexion par Merchant ID -->
<div class="login-screen" id="login-screen">
  <div class="login-card">
    <h2><span class="wazi">Wazi</span><span class="bot">Bot</span></h2>
    <p>Entrez votre identifiant boutique pour acc√©der √† votre dashboard</p>
    <div class="form-group" style="margin-bottom:16px;">
      <input id="login-id" type="text" placeholder="Votre ID boutique..." style="text-align:center;">
    </div>
    <button class="btn btn-primary" onclick="doLogin()">Acc√©der au dashboard ‚Üí</button>
    <p class="login-error" id="login-error">ID invalide. V√©rifiez votre identifiant.</p>
    <p style="color:var(--muted);font-size:12px;margin-top:20px;">Votre ID vous a √©t√© communiqu√© par WaziBot lors de votre inscription.</p>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <div class="logo">
      <h1><span class="wazi">Wazi</span><span class="bot">Bot</span></h1>
      <span>Dashboard Commer√ßant</span>
    </div>
    <nav class="nav">
      <div class="nav-item active" onclick="showPage('stats', this)">
        <span class="icon">üìä</span> Statistiques
      </div>
      <div class="nav-item" onclick="showPage('orders', this)">
        <span class="icon">üì¶</span> Commandes
      </div>
      <div class="nav-item" onclick="showPage('catalog', this)">
        <span class="icon">üõçÔ∏è</span> Catalogue
      </div>
      <div class="nav-item" onclick="showPage('customers', this)">
        <span class="icon">üë•</span> Clients
      </div>
      <div class="nav-item" onclick="showPage('analytics', this)">
        <span class="icon">üìà</span> Analytics
      </div>
      <div class="nav-item" onclick="showPage('settings', this)">
        <span class="icon">‚öôÔ∏è</span> Param√®tres
      </div>
      <div class="nav-item" onclick="doLogout()" style="margin-top:auto;">
        <span class="icon">üö™</span> D√©connexion
      </div>
    </nav>
    <div class="merchant-badge">
      <div class="label">Boutique active</div>
      <div class="name" id="sidebar-name">Chargement...</div>
      <div class="status">‚óè Connect√©</div>
    </div>
  </aside>

  <main class="main">
    <!-- Stats -->
    <div class="page active" id="page-stats">
      <div class="page-header">
        <h2>Vue d'ensemble</h2>
        <p>R√©sum√© de votre activit√© en temps r√©el</p>
      </div>
      <div class="stats-grid">
        <div class="stat-card green"><div class="label">Revenus totaux</div><div class="value" id="stat-revenue">‚Äî</div><div class="sub">FCFA g√©n√©r√©s</div></div>
        <div class="stat-card purple"><div class="label">Commandes</div><div class="value" id="stat-orders">‚Äî</div><div class="sub">Au total</div></div>
        <div class="stat-card orange"><div class="label">En attente</div><div class="value" id="stat-pending">‚Äî</div><div class="sub">√Ä traiter</div></div>
        <div class="stat-card"><div class="label">Clients</div><div class="value" id="stat-customers">‚Äî</div><div class="sub">Uniques</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Derni√®res commandes</h3>
          <button class="btn btn-ghost btn-sm" onclick="showPage('orders', null)">Voir tout ‚Üí</button>
        </div>
        <table>
          <thead><tr><th>N¬∞ Commande</th><th>Client</th><th>Total</th><th>Statut</th><th>Date</th></tr></thead>
          <tbody id="recent-orders"><tr><td colspan="5" class="loader">Chargement...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Commandes -->
    <div class="page" id="page-orders">
      <div class="page-header">
        <h2>Commandes</h2>
        <p>G√©rez et suivez toutes vos commandes</p>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Toutes les commandes</h3>
          <select onchange="filterOrders(this.value)" style="width:auto;padding:6px 12px;font-size:13px;">
            <option value="">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="confirmed">Confirm√©es</option>
            <option value="preparing">En pr√©paration</option>
            <option value="ready">Pr√™tes</option>
            <option value="delivered">Livr√©es</option>
            <option value="cancelled">Annul√©es</option>
          </select>
        </div>
        <table>
          <thead><tr><th>N¬∞ Commande</th><th>Client</th><th>Articles</th><th>Total</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="orders-table"><tr><td colspan="6" class="loader">Chargement...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Catalogue -->
    <div class="page" id="page-catalog">
      <div class="page-header" style="display:flex;align-items:center;justify-content:space-between;">
        <div><h2>Catalogue</h2><p>G√©rez vos produits</p></div>
        <button class="btn btn-primary" onclick="openAddProduct()">+ Ajouter un produit</button>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Produit</th><th>Cat√©gorie</th><th>Prix</th><th>Stock</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="catalog-table"><tr><td colspan="6" class="loader">Chargement...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Clients -->
    <div class="page" id="page-customers">
      <div class="page-header">
        <h2>Clients</h2>
        <p>Historique et profils de vos clients</p>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Num√©ro WhatsApp</th><th>Nom</th><th>Commandes</th><th>Total d√©pens√©</th><th>Derni√®re interaction</th></tr></thead>
          <tbody id="customers-table"><tr><td colspan="5" class="loader">Chargement...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- Analytics -->
    <div class="page" id="page-analytics">
      <div class="page-header">
        <h2>Analytics</h2>
        <p>Performances de votre boutique en temps r√©el</p>
      </div>

      <!-- Filtres p√©riode -->
      <div style="display:flex;gap:8px;margin-bottom:24px;">
        <button class="btn btn-primary btn-sm" onclick="setPeriod('7')" id="btn-7j">7 jours</button>
        <button class="btn btn-ghost btn-sm" onclick="setPeriod('30')" id="btn-30j">30 jours</button>
        <button class="btn btn-ghost btn-sm" onclick="setPeriod('90')" id="btn-90j">90 jours</button>
      </div>

      <!-- KPIs analytics -->
      <div class="stats-grid" style="margin-bottom:24px;">
        <div class="stat-card green">
          <div class="label">Revenus p√©riode</div>
          <div class="value" id="a-revenue">‚Äî</div>
          <div class="sub">FCFA</div>
        </div>
        <div class="stat-card purple">
          <div class="label">Taux de conversion</div>
          <div class="value" id="a-conversion">‚Äî</div>
          <div class="sub">clients ‚Üí acheteurs</div>
        </div>
        <div class="stat-card orange">
          <div class="label">Panier moyen</div>
          <div class="value" id="a-basket">‚Äî</div>
          <div class="sub">FCFA par commande</div>
        </div>
        <div class="stat-card">
          <div class="label">Messages re√ßus</div>
          <div class="value" id="a-messages">‚Äî</div>
          <div class="sub">conversations</div>
        </div>
      </div>

      <!-- Graphique revenus -->
      <div class="card" style="padding:24px;margin-bottom:24px;">
        <div class="card-header" style="padding:0 0 20px 0;border:none;">
          <h3>üìà √âvolution des revenus</h3>
        </div>
        <canvas id="revenueChart" height="100"></canvas>
      </div>

      <!-- Heures de pointe + Conversion c√¥te √† c√¥te -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">

        <!-- Heures de pointe -->
        <div class="card" style="padding:24px;">
          <h3 style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:20px;">‚è∞ Heures de pointe</h3>
          <div id="heatmap" style="display:grid;grid-template-columns:repeat(6,1fr);gap:4px;"></div>
          <div style="display:flex;justify-content:space-between;margin-top:12px;">
            <span style="font-size:11px;color:var(--muted)">0h</span>
            <span style="font-size:11px;color:var(--muted)">4h</span>
            <span style="font-size:11px;color:var(--muted)">8h</span>
            <span style="font-size:11px;color:var(--muted)">12h</span>
            <span style="font-size:11px;color:var(--muted)">16h</span>
            <span style="font-size:11px;color:var(--muted)">20h</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:16px;">
            <span style="font-size:11px;color:var(--muted)">Faible</span>
            <div style="flex:1;height:8px;border-radius:4px;background:linear-gradient(90deg,rgba(0,229,160,0.1),rgba(0,229,160,1));"></div>
            <span style="font-size:11px;color:var(--muted)">√âlev√©</span>
          </div>
        </div>

        <!-- Taux de conversion -->
        <div class="card" style="padding:24px;">
          <h3 style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:20px;">üéØ Entonnoir de conversion</h3>
          <div id="funnel"></div>
        </div>

      </div>
    </div>

    <!-- Param√®tres -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <h2>Param√®tres</h2>
        <p>Configurez votre boutique et votre assistant IA</p>
      </div>
      <div class="card" style="padding:28px;margin-bottom:20px;">
        <h3 style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:20px;">Informations boutique</h3>
        <div class="form-grid">
          <div class="form-group"><label>Nom de la boutique</label><input id="s-name" type="text"></div>
          <div class="form-group"><label>Ville</label><input id="s-city" type="text"></div>
          <div class="form-group"><label>Email</label><input id="s-email" type="email"></div>
          <div class="form-group"><label>Devise</label><input id="s-currency" type="text"></div>
          <div class="form-group full"><label>Description de la boutique</label><textarea id="s-desc"></textarea></div>
          <div class="form-group full"><label>Personnalit√© de l'IA</label><textarea id="s-persona"></textarea></div>
          <div class="form-group full"><label>Message d'accueil</label><textarea id="s-welcome"></textarea></div>
        </div>
        <div style="margin-top:20px;">
          <button class="btn btn-primary" onclick="saveSettings()">Enregistrer</button>
        </div>
      </div>
      <!-- Section Abonnement & Paiement -->
      <div class="card" style="padding:28px;margin-bottom:20px;">
        <h3 style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px;">Abonnement</h3>
        <p style="color:var(--muted);font-size:13px;margin-bottom:20px;">G√©rez votre plan et renouvelez votre abonnement.</p>
        <div id="sub-status" style="background:var(--bg);border-radius:12px;padding:16px;margin-bottom:20px;font-size:13px;">
          Chargement...
        </div>
        <h4 style="font-size:14px;font-weight:700;margin-bottom:16px;">Choisir un plan</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="plan-cards">
          <div class="plan-card" onclick="selectPlan('starter')" data-plan="starter" style="border:2px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;text-align:center;">
            <div style="font-weight:700;font-size:15px;margin-bottom:6px;">Starter</div>
            <div id="price-starter" style="color:var(--accent);font-size:13px;font-weight:600;">‚Äî</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">50 produits ¬∑ 500 msg</div>
          </div>
          <div class="plan-card" onclick="selectPlan('pro')" data-plan="pro" style="border:2px solid var(--accent);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;text-align:center;background:rgba(0,229,160,0.05);">
            <div style="font-weight:700;font-size:15px;margin-bottom:6px;">Pro ‚≠ê</div>
            <div id="price-pro" style="color:var(--accent);font-size:13px;font-weight:600;">‚Äî</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">200 produits ¬∑ 2000 msg</div>
          </div>
          <div class="plan-card" onclick="selectPlan('business')" data-plan="business" style="border:2px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;text-align:center;">
            <div style="font-weight:700;font-size:15px;margin-bottom:6px;">Business</div>
            <div id="price-business" style="color:var(--accent);font-size:13px;font-weight:600;">‚Äî</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Illimit√© ¬∑ Support prioritaire</div>
          </div>
        </div>
        <div style="background:rgba(0,229,160,0.05);border:1px solid rgba(0,229,160,0.2);border-radius:10px;padding:12px 16px;font-size:12px;color:var(--muted);margin-bottom:16px;">
          üí≥ Paiement accept√© : <strong style="color:var(--text);">Mobile Money</strong> (MTN, Orange, Wave...) et <strong style="color:var(--text);">Carte bancaire</strong> (Visa, Mastercard)
        </div>
        <button class="btn btn-primary" onclick="initiatePayment()" style="width:100%;">üí≥ Payer maintenant</button>
      </div>

      <div class="card" style="padding:28px;">
        <h3 style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:8px;">Token WhatsApp</h3>
        <p style="color:var(--muted);font-size:13px;margin-bottom:16px;">Mettez √† jour votre token Meta quand il expire.</p>
        <div class="form-group" style="margin-bottom:16px;">
          <label>Nouveau token d'acc√®s</label>
          <input id="s-token" type="text" placeholder="EAAd...">
        </div>
        <button class="btn btn-primary" onclick="updateToken()">Mettre √† jour le token</button>
      </div>
    </div>
  </main>
</div>

<!-- Modal Produit -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <h3 id="modal-title">Ajouter un produit</h3>
    <div class="form-grid">
      <div class="form-group full"><label>Nom du produit</label><input id="p-name" type="text"></div>
      <div class="form-group"><label>Prix (FCFA)</label><input id="p-price" type="number"></div>
      <div class="form-group"><label>Stock</label><input id="p-stock" type="number"></div>
      <div class="form-group"><label>Cat√©gorie</label><input id="p-category" type="text" placeholder="V√™tements, Chaussures..."></div>
      <div class="form-group"><label>URL Image</label><input id="p-image" type="text"></div>
      <div class="form-group full"><label>Description</label><textarea id="p-desc"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveProduct()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ
const API = 'https://whatsapp-commerce-1roe.onrender.com/api';
const API_KEY = 'WB-' + atob('d2F6aWJvdC1zZWNyZXQta2V5LTIwMjY='); // cl√© encod√©e
let MERCHANT_ID = '';
let editingProductId = null;

// ‚îÄ‚îÄ Login ‚îÄ‚îÄ
async function doLogin() {
  const id = document.getElementById('login-id').value.trim();
  if (!id) return;
  try {
    const res = await fetch(API + '/merchants/' + id, { headers: { 'x-api-key': API_KEY } });
    const data = await res.json();
    if (data.id) {
      MERCHANT_ID = id;
      localStorage.setItem('wazibot_merchant_id', id);
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('sidebar-name').textContent = data.name;
      loadStats();
      loadRecentOrders();
      checkTrialStatus(data);
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  } catch (e) {
    document.getElementById('login-error').style.display = 'block';
  }
}

function doLogout() {
  localStorage.removeItem('wazibot_merchant_id');
  location.reload();
}

// V√©rifier si d√©j√† connect√©
window.addEventListener('DOMContentLoaded', () => {
  // V√©rifier si ID dans URL (venant de signup)
  const urlParams = new URLSearchParams(window.location.search);
  const urlId = urlParams.get('id');
  if (urlId) {
    document.getElementById('login-id').value = urlId;
    doLogin();
    return;
  }
  const saved = localStorage.getItem('wazibot_merchant_id');
  if (saved) {
    document.getElementById('login-id').value = saved;
    doLogin();
  }
});

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function showPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (el) el.classList.add('active');
  loadPage(name);
}

function loadPage(name) {
  if (name === 'stats') { loadStats(); loadRecentOrders(); }
  else if (name === 'orders') loadOrders();
  else if (name === 'catalog') loadCatalog();
  else if (name === 'customers') loadCustomers();
  else if (name === 'analytics') loadAnalytics();
  else if (name === 'settings') { loadSettings(); loadSubscriptionInfo(); }
}

// ‚îÄ‚îÄ API Helper ‚îÄ‚îÄ
async function api(path, method, body) {
  const opts = { method: method || 'GET', headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  return res.json();
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + msg;
  t.className = 'toast show ' + (type || 'success');
  setTimeout(() => t.className = 'toast', 3000);
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
// ‚îÄ‚îÄ V√©rification p√©riode d'essai / expiration ‚îÄ‚îÄ
let currentMerchantData = null;

const PLAN_PRICES_DISPLAY = {
  XOF: { starter: '20 000', pro: '40 000', business: '100 000', currency: 'XOF' },
  XAF: { starter: '20 000', pro: '40 000', business: '100 000', currency: 'XAF' },
  NGN: { starter: '50 000', pro: '100 000', business: '250 000', currency: 'NGN' },
  KES: { starter: '3 500',  pro: '7 000',  business: '18 000',  currency: 'KES' },
  GNF: { starter: '250 000',pro: '500 000',business: '1 250 000',currency: 'GNF' },
  MRO: { starter: '11 000', pro: '22 000', business: '55 000',  currency: 'MRO' },
  RWF: { starter: '34 000', pro: '68 000', business: '170 000', currency: 'RWF' },
  TZS: { starter: '75 000', pro: '150 000',business: '380 000', currency: 'TZS' },
  UGX: { starter: '110 000',pro: '220 000',business: '550 000', currency: 'UGX' },
};

function checkTrialStatus(merchant) {
  currentMerchantData = merchant;
  const now = new Date();
  const expiresAt = merchant.subscriptionExpiresAt ? new Date(merchant.subscriptionExpiresAt) : null;
  const createdAt = merchant.createdAt ? new Date(merchant.createdAt) : null;
  const isExpired = !expiresAt || expiresAt < now;
  const daysLeft = expiresAt ? Math.ceil((expiresAt - now) / (1000*60*60*24)) : 0;
  const daysSinceCreation = createdAt ? Math.floor((now - createdAt) / (1000*60*60*24)) : 0;
  const isInTrial = !merchant.plan || merchant.plan === 'trial' || (daysSinceCreation < 7 && !expiresAt);

  const banner = document.getElementById('trial-banner');
  const title = document.getElementById('trial-title');
  const sub = document.getElementById('trial-sub');
  const icon = document.getElementById('trial-icon');

  // Mettre √† jour les prix selon la devise du commer√ßant
  const cur = merchant.currency || 'XOF';
  const prices = PLAN_PRICES_DISPLAY[cur] || PLAN_PRICES_DISPLAY['XOF'];
  document.getElementById('pm-price-starter').textContent = prices.starter;
  document.getElementById('pm-price-pro').textContent = prices.pro;
  document.getElementById('pm-price-business').textContent = prices.business;
  document.getElementById('pm-currency-starter').textContent = prices.currency + '/mois';
  document.getElementById('pm-currency-pro').textContent = prices.currency + '/mois';
  document.getElementById('pm-currency-business').textContent = prices.currency + '/mois';

  if (isExpired || (isInTrial && daysLeft === 0)) {
    // Expir√© ‚Üí afficher modale imm√©diatement
    icon.textContent = "üîí";
    title.textContent = "Votre acces est expire !";
    sub.textContent = "Choisissez un plan pour continuer.";
    banner.style.display = "block";
    document.getElementById('payment-modal').style.display = 'flex';
  } else if (daysLeft <= 3) {
    // Bient√¥t ‚Üí afficher bandeau avec bouton
    icon.textContent = daysLeft <= 1 ? "üö®" : "‚ö†Ô∏è";
    title.textContent = daysLeft <= 1
      ? "Votre acces expire demain !"
      : "Votre acces expire dans " + daysLeft + " jour(s) !";
    sub.textContent = "Abonnez-vous maintenant pour ne pas perdre votre boutique.";
    banner.style.display = "block";
  }
}

// ‚îÄ‚îÄ S√©lection plan ‚îÄ‚îÄ
let selectedPaymentPlan = 'pro';

function selectPaymentPlan(plan) {
  selectedPaymentPlan = plan;
  const cur = (currentMerchantData && currentMerchantData.currency) || 'XOF';
  const prices = PLAN_PRICES_DISPLAY[cur] || PLAN_PRICES_DISPLAY['XOF'];
  const labels = { starter: 'Starter', pro: 'Pro ‚≠ê', business: 'Business üöÄ' };

  // Highlight plan s√©lectionn√©
  ['starter','pro','business'].forEach(p => {
    const el = document.getElementById('plan-' + p);
    el.style.border = p === plan ? '2px solid #e85c0e' : '2px solid #2a2a3a';
    el.style.background = p === plan ? 'rgba(232,92,14,0.08)' : 'transparent';
  });

  // Afficher step 2
  document.getElementById('selected-amount').textContent = prices[plan] + ' ' + prices.currency;
  document.getElementById('selected-plan-label').textContent = 'Plan ' + labels[plan] + ' ‚Äî par mois';
  document.getElementById('payment-step2').style.display = 'block';
  document.getElementById('transaction-sent').style.display = 'none';
  document.getElementById('transaction-ref').value = '';
}

function backToPlanSelection() {
  document.getElementById('payment-step2').style.display = 'none';
  ['starter','pro','business'].forEach(p => {
    document.getElementById('plan-' + p).style.border = '2px solid #2a2a3a';
    document.getElementById('plan-' + p).style.background = 'transparent';
  });
}

// ‚îÄ‚îÄ Bouton My Touchpoint intelligent ‚îÄ‚îÄ
function openMyTouchpoint() {
  const isAndroid = /android/i.test(navigator.userAgent);
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  
  // Tenter d'ouvrir l'app via deep link
  const deepLink = 'mytouchpoint://pay';
  const androidStore = 'https://play.google.com/store/apps/details?id=com.intouch.mytouchpoint&hl=fr';
  const iosStore = 'https://apps.apple.com/bf/app/mytouchpoint/id6451056179';

  if (isAndroid) {
    window.location = deepLink;
    setTimeout(() => { window.location = androidStore; }, 1500);
  } else if (isIOS) {
    window.location = deepLink;
    setTimeout(() => { window.location = iosStore; }, 1500);
  } else {
    // Desktop ‚Äî afficher les deux liens
    alert('Sur votre telephone :\n\nAndroid : ' + androidStore + '\n\niOS : ' + iosStore);
  }
}

// ‚îÄ‚îÄ Soumettre la transaction ‚îÄ‚îÄ
async function submitTransaction() {
  const ref = document.getElementById('transaction-ref').value.trim();
  if (!ref) { alert('Entrez votre numero de transaction My Touchpoint'); return; }

  const cur = (currentMerchantData && currentMerchantData.currency) || 'XOF';
  const prices = PLAN_PRICES_DISPLAY[cur] || PLAN_PRICES_DISPLAY['XOF'];

  try {
    await fetch(API + '/merchants/' + MERCHANT_ID + '/payment-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
      body: JSON.stringify({
        plan: selectedPaymentPlan,
        transactionRef: ref,
        amount: prices[selectedPaymentPlan],
        currency: cur,
      })
    });
    document.getElementById('transaction-sent').style.display = 'block';
    document.getElementById('transaction-ref').disabled = true;
  } catch(e) {
    alert('Erreur envoi. Reessayez ou contactez le support.');
  }
}

async function loadStats() {
  const data = await api('/merchants/' + MERCHANT_ID + '/stats');
  document.getElementById('stat-revenue').textContent = (data.totalRevenue || 0).toLocaleString('fr-FR');
  document.getElementById('stat-orders').textContent = data.totalOrders || 0;
  document.getElementById('stat-pending').textContent = data.pendingOrders || 0;
  document.getElementById('stat-customers').textContent = data.totalCustomers || 0;
  const merchant = await api('/merchants/' + MERCHANT_ID);
  document.getElementById('sidebar-name').textContent = merchant.name || '‚Äî';
}

async function loadRecentOrders() {
  const orders = await api('/merchants/' + MERCHANT_ID + '/orders');
  const tbody = document.getElementById('recent-orders');
  if (!orders.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="icon">üì≠</div><p>Aucune commande</p></div></td></tr>'; return; }
  tbody.innerHTML = orders.slice(0, 5).map(o => `
    <tr>
      <td><strong>${o.orderNumber}</strong></td>
      <td>${o.customerId || '‚Äî'}</td>
      <td>${(o.totalAmount || 0).toLocaleString('fr-FR')} FCFA</td>
      <td><span class="badge ${o.status}">${statusLabel(o.status)}</span></td>
      <td>${new Date(o.createdAt).toLocaleDateString('fr-FR')}</td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ Commandes ‚îÄ‚îÄ
async function loadOrders(status) {
  const path = '/merchants/' + MERCHANT_ID + '/orders' + (status ? '?status=' + status : '');
  const orders = await api(path);
  const tbody = document.getElementById('orders-table');
  if (!orders.length) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="icon">üì≠</div><p>Aucune commande</p></div></td></tr>'; return; }
  tbody.innerHTML = orders.map(o => {
    const items = JSON.parse(typeof o.items === 'string' ? o.items : JSON.stringify(o.items || []));
    const itemsText = items.map(i => i.name + ' x' + i.quantity).join(', ');
    return `<tr>
      <td><strong>${o.orderNumber}</strong></td>
      <td>${o.customerId || '‚Äî'}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${itemsText}</td>
      <td>${(o.totalAmount || 0).toLocaleString('fr-FR')} FCFA</td>
      <td><span class="badge ${o.status}">${statusLabel(o.status)}</span></td>
      <td>
        <select class="status-select" onchange="changeStatus('${o.id}', this.value)">
          <option value="">Changer...</option>
          <option value="confirmed">Confirmer</option>
          <option value="preparing">Pr√©parer</option>
          <option value="ready">Pr√™te</option>
          <option value="delivered">Livr√©e</option>
          <option value="cancelled">Annuler</option>
        </select>
      </td>
    </tr>`;
  }).join('');
}

function filterOrders(status) { loadOrders(status); }

async function changeStatus(orderId, status) {
  if (!status) return;
  await api('/orders/' + orderId + '/status', 'PATCH', { status });
  toast('Statut mis √† jour !', 'success');
  loadOrders();
}

function statusLabel(s) {
  const labels = { pending: 'En attente', confirmed: 'Confirm√©e', preparing: 'En pr√©paration', ready: 'Pr√™te', delivered: 'Livr√©e', cancelled: 'Annul√©e' };
  return labels[s] || s;
}

// ‚îÄ‚îÄ Catalogue ‚îÄ‚îÄ
async function loadCatalog() {
  const products = await api('/merchants/' + MERCHANT_ID + '/products');
  const tbody = document.getElementById('catalog-table');
  if (!products.length) { tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="icon">üõçÔ∏è</div><p>Aucun produit</p></div></td></tr>'; return; }
  tbody.innerHTML = products.map(p => `
    <tr>
      <td><strong>${p.name}</strong><br><small style="color:var(--muted)">${p.description || ''}</small></td>
      <td>${p.category || '‚Äî'}</td>
      <td>${(p.price || 0).toLocaleString('fr-FR')} FCFA</td>
      <td>${p.stock}</td>
      <td><span class="badge ${p.isAvailable ? 'confirmed' : 'cancelled'}">${p.isAvailable ? 'Disponible' : 'Indispo'}</span></td>
      <td style="display:flex;gap:8px;">
        <button class="btn btn-ghost btn-sm" onclick='editProduct(${JSON.stringify(p)})'>‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">üóëÔ∏è</button>
      </td>
    </tr>`).join('');
}

function openAddProduct() {
  editingProductId = null;
  document.getElementById('modal-title').textContent = 'Ajouter un produit';
  ['p-name','p-price','p-stock','p-category','p-image','p-desc'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('product-modal').classList.add('open');
}

function editProduct(p) {
  editingProductId = p.id;
  document.getElementById('modal-title').textContent = 'Modifier le produit';
  document.getElementById('p-name').value = p.name || '';
  document.getElementById('p-price').value = p.price || '';
  document.getElementById('p-stock').value = p.stock || '';
  document.getElementById('p-category').value = p.category || '';
  document.getElementById('p-image').value = p.imageUrl || '';
  document.getElementById('p-desc').value = p.description || '';
  document.getElementById('product-modal').classList.add('open');
}

function closeModal() { document.getElementById('product-modal').classList.remove('open'); }

async function saveProduct() {
  const data = {
    name: document.getElementById('p-name').value,
    price: parseFloat(document.getElementById('p-price').value),
    stock: parseInt(document.getElementById('p-stock').value),
    category: document.getElementById('p-category').value,
    imageUrl: document.getElementById('p-image').value,
    description: document.getElementById('p-desc').value,
    isAvailable: true,
  };
  if (!data.name || !data.price) { toast('Nom et prix obligatoires', 'error'); return; }
  if (editingProductId) {
    await api('/merchants/' + MERCHANT_ID + '/products/' + editingProductId, 'PATCH', data);
    toast('Produit modifi√© !', 'success');
  } else {
    await api('/merchants/' + MERCHANT_ID + '/products', 'POST', data);
    toast('Produit ajout√© !', 'success');
  }
  closeModal();
  loadCatalog();
}

async function deleteProduct(id) {
  if (!confirm('Supprimer ce produit ?')) return;
  await api('/merchants/' + MERCHANT_ID + '/products/' + id, 'DELETE');
  toast('Produit supprim√©', 'success');
  loadCatalog();
}

// ‚îÄ‚îÄ Clients ‚îÄ‚îÄ
async function loadCustomers() {
  const customers = await api('/merchants/' + MERCHANT_ID + '/customers');
  const tbody = document.getElementById('customers-table');
  if (!customers.length) { tbody.innerHTML = '<tr><td colspan="5"><div class="empty"><div class="icon">üë•</div><p>Aucun client</p></div></td></tr>'; return; }
  tbody.innerHTML = customers.map(c => `
    <tr>
      <td>${c.whatsappNumber}</td>
      <td>${c.name || '<span style="color:var(--muted)">Inconnu</span>'}</td>
      <td>${c.totalOrders}</td>
      <td>${(c.totalSpent || 0).toLocaleString('fr-FR')} FCFA</td>
      <td>${new Date(c.lastInteraction).toLocaleDateString('fr-FR')}</td>
    </tr>`).join('');
}

// ‚îÄ‚îÄ Abonnement & Paiement ‚îÄ‚îÄ
let selectedPlan = 'pro';

async function loadSubscriptionInfo() {
  try {
    const merchant = await api('/merchants/' + MERCHANT_ID);
    const currency = merchant.currency || 'XOF';

    // Afficher statut abonnement
    const exp = merchant.subscriptionExpiresAt ? new Date(merchant.subscriptionExpiresAt) : null;
    const now = new Date();
    const isExpired = !exp || exp < now;
    const daysLeft = isExpired ? 0 : Math.ceil((exp - now) / (1000*60*60*24));
    const statusColor = isExpired ? '#ff4757' : daysLeft < 5 ? '#f0a500' : '#00e5a0';

    document.getElementById('sub-status').innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <span style="font-weight:700;text-transform:uppercase;color:var(--accent);">${merchant.plan || 'starter'}</span>
          <span style="color:var(--muted);font-size:12px;margin-left:8px;">${isExpired ? '‚ö†Ô∏è Expir√©' : '‚óè Actif'}</span>
        </div>
        <div style="color:${statusColor};font-weight:700;font-size:13px;">
          ${isExpired ? 'Renouvelez maintenant' : daysLeft + ' jour(s) restant(s)'}
        </div>
      </div>
      ${exp ? '<div style="color:var(--muted);font-size:12px;margin-top:6px;">Expire le ' + exp.toLocaleDateString('fr-FR') + '</div>' : ''}
    `;

    // Afficher les prix selon la devise
    const plans = await fetch('/subscription/plans?currency=' + currency).then(r => r.json());
    plans.forEach(p => {
      const el = document.getElementById('price-' + p.plan);
      if (el) el.textContent = p.price.toLocaleString('fr-FR') + ' ' + p.currency + '/mois';
    });
  } catch(e) {
    console.error('Erreur chargement abonnement:', e);
  }
}

function selectPlan(plan) {
  selectedPlan = plan;
  document.querySelectorAll('.plan-card').forEach(c => {
    c.style.border = '2px solid var(--border)';
    c.style.background = 'transparent';
  });
  const el = document.querySelector(`[data-plan="${plan}"]`);
  if (el) {
    el.style.border = '2px solid var(--accent)';
    el.style.background = 'rgba(0,229,160,0.05)';
  }
}

async function initiatePayment() {
  try {
    const res = await fetch('/subscription/initiate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ merchantId: MERCHANT_ID, plan: selectedPlan })
    });
    const data = await res.json();
    if (data.checkoutUrl) {
      window.open(data.checkoutUrl, '_blank');
    } else {
      toast('Erreur : ' + (data.error || 'Impossible de cr√©er le lien'), 'error');
    }
  } catch(e) {
    toast('Erreur paiement', 'error');
  }
}

// ‚îÄ‚îÄ Param√®tres ‚îÄ‚îÄ
async function loadSettings() {
  const m = await api('/merchants/' + MERCHANT_ID);
  document.getElementById('s-name').value = m.name || '';
  document.getElementById('s-city').value = m.city || '';
  document.getElementById('s-email').value = m.email || '';
  document.getElementById('s-currency').value = m.currency || 'FCFA';
  document.getElementById('s-desc').value = m.businessDescription || '';
  document.getElementById('s-persona').value = m.aiPersona || '';
  document.getElementById('s-welcome').value = m.welcomeMessage || '';
}

async function saveSettings() {
  await api('/merchants/' + MERCHANT_ID, 'PATCH', {
    name: document.getElementById('s-name').value,
    city: document.getElementById('s-city').value,
    email: document.getElementById('s-email').value,
    currency: document.getElementById('s-currency').value,
    businessDescription: document.getElementById('s-desc').value,
    aiPersona: document.getElementById('s-persona').value,
    welcomeMessage: document.getElementById('s-welcome').value,
  });
  toast('Param√®tres enregistr√©s !', 'success');
  document.getElementById('sidebar-name').textContent = document.getElementById('s-name').value;
}

async function updateToken() {
  const token = document.getElementById('s-token').value.trim();
  if (!token) { toast('Token vide', 'error'); return; }
  await api('/merchants/' + MERCHANT_ID, 'PATCH', { whatsappToken: token });
  toast('Token mis √† jour !', 'success');
  document.getElementById('s-token').value = '';
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// ‚îÄ‚îÄ Analytics ‚îÄ‚îÄ
let currentPeriod = '7';
let revenueChartInstance = null;

function setPeriod(days) {
  currentPeriod = days;
  ['7','30','90'].forEach(d => {
    document.getElementById('btn-'+d+'j').className = d === days ? 'btn btn-primary btn-sm' : 'btn btn-ghost btn-sm';
  });
  loadAnalytics();
}

async function loadAnalytics() {
  const orders = await api('/merchants/' + MERCHANT_ID + '/orders');
  const customers = await api('/merchants/' + MERCHANT_ID + '/customers');

  const days = parseInt(currentPeriod);
  const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
  const filtered = orders.filter(o => new Date(o.createdAt) >= cutoff && o.status !== 'cancelled');

  // KPIs
  const revenue = filtered.reduce((s, o) => s + (o.totalAmount || 0), 0);
  const buyers = new Set(filtered.map(o => o.customerId)).size;
  const totalCustomers = customers.length || 1;
  const conversion = Math.round((buyers / totalCustomers) * 100);
  const basket = filtered.length ? Math.round(revenue / filtered.length) : 0;
  const messages = customers.reduce((s, c) => s + (c.totalOrders || 0), 0) * 3;

  document.getElementById('a-revenue').textContent = revenue.toLocaleString('fr-FR');
  document.getElementById('a-conversion').textContent = conversion + '%';
  document.getElementById('a-basket').textContent = basket.toLocaleString('fr-FR');
  document.getElementById('a-messages').textContent = messages;

  // Graphique revenus par jour
  const revenueByDay = {};
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
    const key = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    revenueByDay[key] = 0;
  }
  filtered.forEach(o => {
    const key = new Date(o.createdAt).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    if (revenueByDay[key] !== undefined) revenueByDay[key] += (o.totalAmount || 0);
  });

  const labels = Object.keys(revenueByDay);
  const values = Object.values(revenueByDay);

  if (revenueChartInstance) revenueChartInstance.destroy();
  const ctx = document.getElementById('revenueChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(0,229,160,0.3)');
  gradient.addColorStop(1, 'rgba(0,229,160,0)');

  revenueChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Revenus (FCFA)',
        data: values,
        borderColor: '#00e5a0',
        backgroundColor: gradient,
        borderWidth: 2,
        pointBackgroundColor: '#00e5a0',
        pointRadius: 4,
        tension: 0.4,
        fill: true,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1c1c27',
          borderColor: '#2a2a3a',
          borderWidth: 1,
          titleColor: '#f0f0f8',
          bodyColor: '#00e5a0',
          callbacks: { label: ctx => ctx.parsed.y.toLocaleString('fr-FR') + ' FCFA' }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#6b6b8a', font: { size: 11 } } },
        y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#6b6b8a', font: { size: 11 }, callback: v => v.toLocaleString('fr-FR') } }
      }
    }
  });

  // Heures de pointe (simulation bas√©e sur les commandes)
  const hourCounts = new Array(24).fill(0);
  orders.forEach(o => {
    const h = new Date(o.createdAt).getHours();
    hourCounts[h]++;
  });
  // Ajouter des donn√©es r√©alistes si peu de donn√©es
  if (orders.length < 5) {
    [8,9,10,12,13,17,18,19,20,21].forEach(h => hourCounts[h] += Math.floor(Math.random() * 5) + 2);
  }
  const maxHour = Math.max(...hourCounts) || 1;
  const heatmap = document.getElementById('heatmap');
  heatmap.innerHTML = hourCounts.map((count, h) => {
    const intensity = count / maxHour;
    const bg = `rgba(0,229,160,${0.05 + intensity * 0.95})`;
    return `<div title="${h}h: ${count} messages" style="height:40px;border-radius:6px;background:${bg};cursor:pointer;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"></div>`;
  }).join('');

  // Entonnoir de conversion
  const total = customers.length;
  const withOrder = customers.filter(c => c.totalOrders > 0).length;
  const repeat = customers.filter(c => c.totalOrders > 1).length;
  const funnel = document.getElementById('funnel');
  funnel.innerHTML = [
    { label: 'Contacts WhatsApp', value: total, color: '#7c5cfc' },
    { label: 'Ont command√©', value: withOrder, color: '#00e5a0' },
    { label: 'Clients fid√®les', value: repeat, color: '#ffa502' },
  ].map((item, i) => {
    const pct = total ? Math.round((item.value / total) * 100) : 0;
    const width = 100 - i * 15;
    return `
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:13px;color:var(--muted)">${item.label}</span>
          <span style="font-size:13px;font-weight:700;color:${item.color}">${item.value} (${pct}%)</span>
        </div>
        <div style="width:100%;height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;">
          <div style="width:${pct}%;height:100%;background:${item.color};border-radius:5px;transition:width 1s ease;"></div>
        </div>
      </div>`;
  }).join('');
}
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(() => console.log('PWA pr√™te !'))
    .catch(err => console.log('SW erreur:', err));
}
</script>
</body>
</html>